#!/usr/bin/env python3

"""Nyan Cat animated progress bar widget for ranma status bar."""
# Sprite data from nyan-mode (GPL-3.0): https://github.com/TeMPOraL/nyan-mode

import argparse
import os
import struct
import subprocess
import sys
import threading
import time
import zlib

TMP_DIR = "/tmp/ranma_nyan_cat"
SCENE_W = 100
SCENE_H = 15
CAT_W = 25
CAT_H = 15
NUM_FRAMES = 6
IMAGE_SCALE = 1
METRIC_POLL_CPU = 2
METRIC_POLL_BATTERY = 30

SPEED_SLOW = 0.30
SPEED_FAST = 0.08


def _decode_frame(hex_rows):
    rows = []
    for h in hex_rows:
        row = []
        for i in range(0, len(h), 8):
            row.append((int(h[i:i+2], 16), int(h[i+2:i+4], 16),
                        int(h[i+4:i+6], 16), int(h[i+6:i+8], 16)))
        rows.append(row)
    return rows


_CAT_HEX = [
    [
        "522244FF522244FF522244FF522244FF522244FF522244FF3F1E31FF403326FF403326FF403326FF403326FF403326FF403326FF403326FF403326FF403326FF403326FF403326FF403326FF2C2F32FF0000000000000000000000000000000000000000",
        "BF1119FFBF1119FFBF1119FFBF1119FFBF1119FF7C0B10FF947256FFFFCC99FFFFBCB9FFFFB3CCFFFFB3CCFFFFB3CCFFFFB3CCFFFFB3CCFFFFB3CCFFFFB3CCFFFFB3CCFFFFB3CCFFFFC7A4FFD8AD82FF383838FF00000000000000000000000000000000",
        "F52A02FFF52A02FFF52A02FFF52A02FFF52A02FF490C00FFF0C090FFFFBCB9FFFF99FFFFFF99FFFFFF99FFFFFF99FFFFFF5FC5FFFF99FFFFFF66CCFFFF92F8FFFF99FFFFFF99FFFFFFA8E0FFFFCC99FF745D46FF00000000000000000000000000000000",
        "FC7800FFFC7800FFFC7800FFFC7800FFFC7800FF4C2400FFF0B6A2FFFF99FFFFFF66CCFFFF92F8FFFF99FFFFFF99FFFFFF99FFFFFF99FFFFD882D8FFC576C5FFFF92F8FFFF8DF3FFFF92F8FFFFA8E0FF745D46FF00000000000000000000000000000000",
        "FBA500FFFBA500FFFBA500FFFBA500FFFBA500FF4C3100FFF0B6A2FFFF99FFFFFF99FFFFFF99FFFFFF99FFFFFF99FFFFFF99FFFFD17DD1FF614C61FF4C4C4CFFAA66AAFFFF7CE2FFFF92F8FFFFA8E0FF745D46FF000000004A4A4AFF0000000000000000",
        "C4AC00FF3C3400FF3C3400FF615600FFF0D300FF483F00FFF0B6A2FFFF99FFFFFF99FFFFFF99FFFFFF99FFFFFF66CCFFFF92F8FFA261A2FF5D5D5DFF969696FF625962FFAE68AEFFFF99FFFFFFA8E0FF745D46FF616161FF999999FF4A4A4AFF00000000",
        "889000FF383838FF8F8F8FFF222222FF3D4100FF292B00FFF0B6A2FFFF99FFFFFF99FFFFFF86ECFFFF99FFFFFF99FFFFFF99FFFFA261A2FF5D5D5DFF999999FF999999FF5D5D5DFF222222FF2A2A2AFF616161FF999999FF999999FF4A4A4AFF00000000",
        "438500FF142700FF383838FF868686FF2A2A2AFF000000FFF0B6A2FFFF99FFFFFF99FFFFFF72D8FFFF99FFFFFF99FFFFF069C9FF6D4C6DFF7B7B7BFF999999FF999999FF999999FF999999FF999999FF999999FF999999FF999999FF737373FF00000000",
        "2CCB13FF26B210FF082903FF383838FF888888FF222222FFF0B6A2FFFF7CE2FFFF80E6FFFF99FFFFFF99FFFFFF99FFFFE073CDFF383838FF999999FFA0A0A0FFA6A6A6FF686868FF999999FF999999FF999999FFCFCFCFFF464646FF999999FF2A2A2AFF",
        "20D15CFF20D15CFF20D15CFF083919FF041C0CFF000000FFF0B6A2FFFF99FFFFFF99FFFFFF99FFFFFF8DF3FFFF92F8FFE086E0FF383838FFA89999FFA68F8FFF262626FF616161FF999999FF767676FF686868FF383838FF4C4646FFB59999FF2B2525FF",
        "0EA7CBFF0EA7CBFF0EA7CBFF0EA7CBFF0A819CFF02191FFFF0BB99FFFFA8E0FFFF77DDFFFF92F8FFFF86ECFFFF86ECFFE086E0FF383838FFD79999FFF69999FF868686FF7B7B7BFF999999FF616161FF999999FF5D5D5DFFB59999FFFF9999FF3E2525FF",
        "1E80F7FF1E80F7FF1E80F7FF1E80F7FF1E80F7FF09264AFFF0BB99FFFFC7A4FFFF95D5FFFF99FFFFFF99FFFFFF99FFFFF794F7FF885788FF7B6C6CFFB09999FF616161FF161616FF222222FF0C0C0CFF2A2A2AFF0C0C0CFFA09999FF775E5EFF00000000",
        "5247F7FF5247F7FF5247F7FF4D43E9FF322E75FF222222FF423B34FFBF9973FFBF9973FFBF9973FFBF9973FFBF9973FFBF9973FFBF9973FF4B3C2DFF616161FF737373FF737373FF737373FF737373FF737373FF737373FF54575AFF0000000000000000",
        "5536D9FF5536D9FF5536D9FF432AABFF4A4A4AFF999999FF464646FF120B2DFF000810FF4A4A4AFF2A2A2AFF001020FF000000000000000000000000070B0FFF4A4A4AFF222222FF00000000161616FF4A4A4AFF161616FF000000000000000000000000",
        "263498FF263498FF263498FF1D2877FF161616FF222222FF000810FF202C81FF001020FF222222FF172635FF0000000000000000000000000000000000000000262626FF161616FF0000000000000000222222FF00000000000000000000000000000000",
    ],
    [
        "522244FF522244FF522244FF522244FF522244FF431C38FF3F3127FF3F3127FF3F3127FF3F3127FF403326FF403326FF403326FF403326FF403326FF403326FF3F3127FF3F3127FF3F3127FF000000000000000000000000000000000000000000000000",
        "BF1119FFBF1119FFBF1119FFBF1119FF930D13FF764939FFF7C694FFFFC1AFFFFFB3CCFFFFB3CCFFFFB3CCFFFFB3CCFFFFB3CCFFFFB3CCFFFFB3CCFFFFB3CCFFFFB3CCFFFFC1AFFFF7C694FF584E44FF0000000000000000000000000000000000000000",
        "F52A02FFF52A02FFF52A02FFF52A02FF851601FFB28E6BFFFFC5A7FFFFA0F0FFFF9CF9FFFF99FFFFFF99FFFFFF68CEFFFF8EF4FFFF7BE1FFFF7BE1FFFF99FFFFFF9CF9FFFFA0F0FFFFC5A7FFB28E6BFF0000000000000000000000000000000000000000",
        "FC7800FFFC7800FFFC7800FFFC7800FF894100FFB28E6BFFFF9CF9FFFF79DFFFFF80E6FFFF9CF9FFFF99FFFFFF99FFFFFF9CF9FFFF99FFFFD882D8FFC576C5FFFF90F6FFFF8EF4FFFF9CF9FFB28E6BFF0000000000000000000000000000000000000000",
        "FBA500FFFBA500FFFBA500FFFBA500FF885900FFB28E6BFFFF9CF9FFFF99FFFFFF99FFFFFF99FFFFFF99FFFFFF99FFFFFF9CF9FFD17DD1FF614C61FF514C51FFAA5599FFFF80E6FFFF9CF9FFB28E6BFF00000000000000004C4C4CFF0000000000000000",
        "F0D300FFF0D300FFF0D300FFF0D300FF827300FFB28E6BFFFF9CF9FFFF99FFFFFF99FFFFFF99FFFFFF7BE1FFFF7BE1FFFF99FFFFA261A2FF5D5D5DFF969696FF625962FFAE68AEFFFF9CF9FFB28E6BFF00070EFF5B5E61FF999999FF4C4C4CFF00000000",
        "6F7509FF252525FF6F7509FFB2BD00FF626800FFB28E6BFFFF9CF9FFFF99FFFFFF80E6FFFF9CF9FFFF99FFFFFF99FFFFFF99FFFFA261A2FF5D5D5DFF999999FF999999FF5D5D5DFF252525FF252525FF616161FF999999FF999999FF4C4C4CFF00000000",
        "252525FF999999FF2A2A2AFF254900FF152900FFB28E6BFFFF9CF9FFFF99FFFFFF79DFFFFF99FFFFFF99FFFFFF79DFFFF08AE9FF6D4C6DFF7B7B7BFF999999FF999999FF999999FF999999FF999999FF999999FF999999FF999999FF737373FF00000000",
        "227C13FF5D5D5DFF7B7B7BFF737373FF3F3F3FFFB28E6BFFFF8EF4FFFF6DD3FFFF99FFFFFF99FFFFFF99FFFFFF80E6FFE086E0FF383838FF999999FFA0A0A0FFA6A6A6FF686868FF999999FF999999FF999999FFCFCFCFFF4C4646FF999999FF252525FF",
        "20D15CFF14843AFF083417FF6F706FFF3F3F3FFFB28E6BFFFF9CF9FFFF9CF9FFFF99FFFFFF99FFFFFF88EEFFFF99FFFFE086E0FF383838FFA89999FFA68F8FFF252525FF686868FF999999FF7B7B7BFF686868FF383838FF4C4646FFB09999FF2B2525FF",
        "0EA7CBFF0EA7CBFF0EA7CBFF075568FF032D37FFB28E6BFFFFAFD2FFFF80E6FFFF80E6FFFF8EF4FFFF7BE1FFFF99FFFFE086E0FF383838FFD79999FFF69999FF7D7D7DFF7D7D7DFF999999FF616161FF999999FF5B5E61FFB09999FFFF9999FF3E2525FF",
        "1E80F7FF1E80F7FF1E7FF7FF1E7FF7FF104586FFB28E6BFFFFCA9EFFFFA4C8FFFF90F6FFFF99FFFFFF9CF9FFFF99FFFFF794F7FF885788FF7B6C6CFFB09999FF616161FF171717FF252525FF0C0C0CFF252525FF0C0C0CFFA09999FF775E5EFF00000000",
        "5247F7FF5247F7FF5247F7FF4D43E9FF322E75FF252525FFB6926EFFBF9973FFBF9973FFBF9973FFBF9973FFBF9973FFBF9973FFBF9973FF4B3C2DFF616161FF737373FF737373FF737373FF737373FF737373FF737373FF54575AFF0000000000000000",
        "5536D9FF5536D9FF5536D9FF432AABFF4A4A4AFF999999FF100D1CFF180F3EFF333333FF414141FF070B0FFF00000000000000000000000000000000070B0FFF4C4C4CFF252525FF00000000111111FF4C4C4CFF0F1011FF000000000000000000000000",
        "263498FF263498FF263498FF1E2974FF0F1011FF252525FF1E2974FF212E87FF00000000202020FF000000000000000000000000000000000000000000000000252525FF111111FF0000000000000000252525FF07090AFF000000000000000000000000",
    ],
    [
        "522244FF522244FF522244FF522244FF522244FF522244FF3F1E31FF403326FF403326FF403326FF403326FF403326FF403326FF403326FF403326FF403326FF403326FF403326FF403326FF2C2F32FF0000000000000000000000000000000000000000",
        "BF1119FFBF1119FFBF1119FFBF1119FFBF1119FF7C0B10FF947256FFFFCC99FFFFBCB9FFFFB3CCFFFFB3CCFFFFB3CCFFFFB3CCFFFFB3CCFFFFB3CCFFFFB3CCFFFFB3CCFFFFB3CCFFFFC7A4FFD8AD82FF383838FF00000000000000000000000000000000",
        "F52A02FFF52A02FFF52A02FFF52A02FFF52A02FF490C00FFF0C090FFFFBCB9FFFF99FFFFFF99FFFFFF99FFFFFF99FFFFFF5FC5FFFF99FFFFFF66CCFFFF92F8FFFF99FFFFFF99FFFFFFA6E6FFFFCC99FF745D46FF00000000000000000000000000000000",
        "FC7800FFFC7800FFFC7800FFFC7800FFFC7800FF4C2400FFF0B6A2FFFF99FFFFFF66CCFFFF92F8FFFF99FFFFFF99FFFFFF99FFFFFF99FFFFFF99FFFFC979C9FFD17DD1FFFF8DF3FFFF92F8FFFFA8E0FF745D46FF00000000000000000000000000000000",
        "FBA500FFFBA500FFFBA500FFFBA500FFFBA500FF4C3100FFF0B6A2FFFF99FFFFFF99FFFFFF99FFFFFF99FFFFFF99FFFFFF99FFFFFF99FFFFB26BB2FF544C54FF5E4D5EFFC95BACFFFF92F8FFFFA8E0FF745D46FF00000000000000004C4C4CFF00000000",
        "F0D300FFF0D300FFF0D300FFF0D300FFF0D300FF483F00FFF0B6A2FFFF99FFFFFF99FFFFFF99FFFFFF99FFFFFF66CCFFFF92F8FFFF99FFFF643C64FF828282FF8D8D8DFF544C54FFDC84DCFFFFA8E0FF745D46FF030C16FF7D7D7DFF999999FF262626FF",
        "B4BF00FFB4BF00FFB4BF00FFB4BF00FFB4BF00FF363900FFF0B6A2FFFF99FFFFFF99FFFFFF86ECFFFF99FFFFFF99FFFFFF99FFFFFF99FFFF643C64FF828282FF999999FF999999FF383838FF262626FF262626FF828282FF999999FF999999FF262626FF",
        "4D9801FF4D9801FF4D9801FF4D9801FF3C7501FF0B1700FFF0B6A2FFFF99FFFFFF99FFFFFF72D8FFFF99FFFFFF99FFFFFF72D8FFD17DD1FF614C61FF8B8B8BFF999999FF999999FF999999FF999999FF999999FF999999FF999999FF999999FF616161FF",
        "2CCB13FF2CCB13FF145C08FF0B3204FF061B02FF000000FFF0B6A2FFFF77DDFFFF80E6FFFF99FFFFFF99FFFFFF99FFFFFF80E6FFA261A2FF5D5D5DFF999999FFB2B2B2FF777777FF828282FF999999FF999999FF999999FFB2B2B2FF5A5A5AFF979797FF",
        "189E45FF151515FF7A7A7AFF919191FF6D6D6DFF1E262EFFF0B6A2FFFF99FFFFFF99FFFFFF99FFFFFF92F8FFFF92F8FFFF99FFFFA261A2FF5D5D5DFFAF9999FF847373FF262626FF828282FF999999FF5A5A5AFF7D7D7DFF262626FF6F6161FFB39999FF",
        "0C92B2FF285059FF4C4C4CFF383838FF03252EFF02191FFFF0BB99FFFFA8E0FFFF77DDFFFF92F8FFFF86ECFFFF86ECFFFF99FFFFA261A2FF5D5D5DFFF09999FFDD9999FF6D6D6DFF8B8B8BFF828282FF777777FF999999FF616161FFCE9999FFFF9999FF",
        "1E7FF7FF1A70D8FF165FB9FF165FB9FF196ED5FF052749FFF0BB99FFFFC7A4FFFF95D5FFFF99FFFFFF99FFFFFF99FFFFFF99FFFFE88BE8FF634463FF9D8888FFAF9999FF414141FF1C1C1CFF1C1C1CFF151515FF262626FF2A2A2AFFA69999FF5C4242FF",
        "5247F7FF5247F7FF5247F7FF5247F7FF5247F7FF18154AFF383838FFBF9973FFBF9973FFBF9973FFBF9973FFBF9973FFBF9973FFBF9973FFBF9973FF27221CFF737373FF737373FF737373FF737373FF737373FF737373FF737373FF373E44FF00000000",
        "5536D9FF5536D9FF5536D9FF5536D9FF5536D9FF191041FFBF9973FF1E262EFF001122FF0E0E0EFF4C4C4CFF1C1C1CFF00000000000000000000000000000000001122FF2A2A2AFF4C4C4CFF00070FFF00000000383838FF383838FF0000000000000000",
        "263498FF263498FF263498FF263498FF263498FF0B0F2DFF262626FF212646FF002E5DFF00000000262626FF0E0E0EFF0000000000000000000000000000000000000000000000002A2A2AFF00000000000000001E262EFF1C1C1CFF0000000000000000",
    ],
    [
        "522244FF522244FF522244FF522244FF522244FF431C38FF3F3127FF403326FF403326FF403326FF403326FF403326FF403326FF403326FF403326FF403326FF3F3127FF3F3127FF3F3127FF000000000000000000000000000000000000000000000000",
        "BF1119FFBF1119FFBF1119FFBF1119FF930D13FF764939FFF7C694FFFFC1AFFFFFB3CCFFFFB3CCFFFFB3CCFFFFB3CCFFFFB3CCFFFFB3CCFFFFB3CCFFFFB3CCFFFFB3CCFFFFC1AFFFF7C694FF584E44FF0000000000000000000000000000000000000000",
        "F52A02FFF52A02FFF52A02FFF52A02FF851601FFB28E6BFFFFC5A7FFFFA0F0FFFF99FFFFFF99FFFFFF99FFFFFF68CEFFFF90F6FFFF7DE3FFFF7DE3FFFF99FFFFFF9CF9FFFFA0F0FFFFC5A7FFB28E6BFF0000000000000000000000000000000000000000",
        "FC7800FFFC7800FFFC7800FFFC7800FF894100FFB28E6BFFFF9CF9FFFF79DFFFFF7DE3FFFF9CF9FFFF99FFFFFF99FFFFFF99FFFFFF9CF9FFD17DD1FFC576C5FFFF90F6FFFF8EF4FFFF9CF9FFB28E6BFF0000000000000000000000000000000000000000",
        "FBA500FFFBA500FFFBA500FFFBA500FF885900FFB28E6BFFFF9CF9FFFF99FFFFFF99FFFFFF99FFFFFF99FFFFFF99FFFFFF99FFFFD17DD1FF614C61FF514C51FFAA5599FFFF80E6FFFF9CF9FFB28E6BFF00000000000000004C4C4CFF0000000000000000",
        "F0D300FFF0D300FFF0D300FFF0D300FF827300FFB28E6BFFFF9CF9FFFF99FFFFFF99FFFFFF99FFFFFF7DE3FFFF7DE3FFFF99FFFFA261A2FF5D5D5DFF969696FF625962FFAE68AEFFFF9CF9FFB28E6BFF00070EFF5B5E61FF999999FF4A4A4AFF00000000",
        "B4BF00FFB4BF00FFB4BF00FFB4BF00FF626800FFB28E6BFFFF9CF9FFFF99FFFFFF88EEFFFF99FFFFFF99FFFFFF99FFFFFF99FFFFA261A2FF5D5D5DFF999999FF999999FF5D5D5DFF262626FF262626FF616161FF999999FF999999FF4C4C4CFF00000000",
        "4D9801FF4D9801FF4D9801FF284E00FF152900FFB28E6BFFFF9CF9FFFF9CF9FFFF79DFFFFF99FFFFFF99FFFFFF79DFFFF08AE9FF6D4C6DFF7B7B7BFF999999FF999999FF999999FF999999FF999999FF999999FF999999FF999999FF737373FF00000000",
        "2CCB13FF1B800CFF0B3204FF6F706FFF3F3F3FFFB28E6BFFFF8EEBFFFF6DD3FFFF99FFFFFF99FFFFFF99FFFFFF88EEFFE083DDFF383838FF999999FFA0A0A0FFA0A0A0FF616161FF999999FF999999FF999999FFCFCFCFFF4C4646FF999999FF262626FF",
        "1B7F3DFF5B5E61FF7D7D7DFF737373FF3F3F3FFFB28E6BFFFF9CF9FFFF99FFFFFF99FFFFFF8EF4FFFF88EEFFFF99FFFFE083DDFF383838FFA89999FFA68F8FFF262626FF5D5D5DFF999999FF7B7B7BFF616161FF3F3F3FFF4C4646FFB09999FF2B2525FF",
        "262626FF999999FF262626FF065062FF032D37FFB28E6BFFFFAFD2FFFF88EEFFFF88EEFFFF8EF4FFFF7DE3FFFF99FFFFE086E0FF383838FFD79999FFF69999FF7B7B7BFF969696FF999999FF616161FF999999FF5D5D5DFFB09999FFFF9999FF3E2525FF",
        "1A5195FF262626FF1A5091FF1D7EF5FF104586FFB28E6BFFFFCA9EFFFFA4C8FFFF8EF4FFFF99FFFFFF99FFFFFF99FFFFF794F7FF885788FF7B6C6CFFB09999FF616161FF171717FF262626FF0C0C0CFF262626FF0C0C0CFFA09999FF775E5EFF00000000",
        "5247F7FF5247F7FF5247F7FF4D43E9FF322E75FF262626FFB6926EFFBF9973FFBF9973FFBF9973FFBF9973FFBF9973FFBF9973FFBF9973FF4B3C2DFF616161FF737373FF737373FF737373FF737373FF737373FF737373FF54575AFF0000000000000000",
        "5536D9FF5536D9FF5536D9FF432AABFF464646FF999999FF100D1CFF180F3EFF333333FF414141FF070B0FFF00000000000000000000000000000000070B0FFF4C4C4CFF262626FF00000000111111FF4C4C4CFF111111FF000000000000000000000000",
        "263498FF263498FF263498FF1E2974FF0F1011FF262626FF1E2974FF212E87FF192633FF202020FF000000000000000000000000000000000000000000000000262626FF111111FF0000000000000000262626FF07090AFF000000000000000000000000",
    ],
    [
        "522244FF522244FF522244FF522244FF522244FF522244FF3F1E31FF403326FF403326FF403326FF403326FF403326FF403326FF403326FF403326FF403326FF403326FF403326FF403326FF2C2F32FF0000000000000000000000000000000000000000",
        "BF1119FFBF1119FFBF1119FFBF1119FFBF1119FF7C0B10FF947256FFFFCC99FFFFBCB9FFFFB3CCFFFFB3CCFFFFB3CCFFFFB3CCFFFFB3CCFFFFB3CCFFFFB3CCFFFFB3CCFFFFB3CCFFFFC7A2FFD8AD82FF3A3C3EFF00000000000000000000000000000000",
        "F52A02FFF52A02FFF52A02FFF52A02FFF52A02FF490C00FFF0C090FFFFBCB9FFFF99FFFFFF99FFFFFF99FFFFFF99FFFFFF5FC5FFFF99FFFFFF66CCFFFF92F8FFFF99FFFFFF99FFFFFFA6E6FFFFCC99FF745D46FF00000000000000000000000000000000",
        "FC7800FFFC7800FFFC7800FFFC7800FFFC7800FF4C2400FFF0B6A2FFFF99FFFFFF66CCFFFF92F8FFFF99FFFFFF99FFFFFF99FFFFFF99FFFFD882D8FFC576C5FFFF9DF7FFFF8DF3FFFF94FAFFFFA8E0FF745D46FF00000000000000000000000000000000",
        "FBA500FFFBA500FFFBA500FFFBA500FFFBA500FF4C3100FFF0B6A2FFFF99FFFFFF99FFFFFF99FFFFFF99FFFFFF99FFFFFF99FFFFD17DD1FF614C61FF4F4F4FFFAA66AAFFFF77DDFFFF92F8FFFFA8E0FF745D46FF000000004F4F4FFF0000000000000000",
        "F0D300FFF0D300FFF0D300FFF0D300FFF0D300FF483F00FFF0B6A2FFFF99FFFFFF99FFFFFF99FFFFFF99FFFFFF66CCFFFF92F8FFA261A2FF5D5D5DFF969696FF5D5D5DFFAE68AEFFFF9DF7FFFFA8E0FF745D46FF5D5D5DFF969696FF494949FF00000000",
        "6F7509FF262626FF262626FF1D1F00FF868F00FF292B00FFF0B6A2FFFF99FFFFFF99FFFFFF85EBFFFF99FFFFFF99FFFFFF99FFFFA261A2FF5D5D5DFF999999FF999999FF575757FF2B2525FF2B2525FF616161FF999999FF999999FF4F4F4FFF00000000",
        "131313FF727272FF999999FF4F4F4FFF2A2A2AFF000000FFF0B6A2FFFF99FFFFFF99FFFFFF72D8FFFF99FFFFFF99FFFFF069C9FF6D4C6DFF7B7B7BFF999999FF999999FF999999FF999999FF999999FF999999FF999999FF999999FF727272FF00000000",
        "20980EFF236119FF262626FF262626FF494949FF262626FFF0B6A2FFFF77DDFFFF80E6FFFF99FFFFFF99FFFFFF99FFFFE073CDFF383838FF999999FFA0A0A0FFA6A6A6FF616161FF999999FF999999FF999999FFCFCFCFFF414141FF999999FF262626FF",
        "20D15CFF20D15CFF20D15CFF1AAF4DFF083417FF020F06FFF0B6A2FFFF99FFFFFF99FFFFFF99FFFFFF8DF3FFFF92F8FFE086E0FF383838FFA89999FFA68F8FFF222126FF5D5D5DFF999999FF7B7B7BFF666666FF3A3C3EFF4C4646FFB59999FF2B2525FF",
        "0EA7CBFF0EA7CBFF0EA7CBFF0EA7CBFF0EA7CBFF04323DFFF0BB99FFFFA8E0FFFF77DDFFFF92F8FFFF85EBFFFF85EBFFE086E0FF383838FFD79999FFF69999FF947256FF969696FF999999FF616161FF999999FF616161FFB59999FFFF9999FF3E2525FF",
        "1E80F7FF1E80F7FF1E80F7FF1E80F7FF1354A2FF000A14FFF0C090FFFFC7A2FFFF95D5FFFF99FFFFFF99FFFFFF99FFFFF794F7FF885788FF7B6C6CFFB09999FF616161FF161616FF262626FF0C0C0CFF20262CFF000A14FF999999FF7B6C6CFF00000000",
        "5247F7FF5247F7FF5247F7FF39329CFF2A2A2AFF262626FF251E17FFBF9973FFBF9973FFBF9973FFBF9973FFBF9973FFBF9973FFBF9973FF4B3C2DFF616161FF727272FF727272FF727272FF727272FF727272FF727272FF54575AFF0000000000000000",
        "5536D9FF5536D9FF5536D9FF262626FF999999FF616161FF241856FF191919FF4F4F4FFF070B0FFF00000000000000000000000000000000000A14FF414141FF333333FF00000000000A14FF4F4F4FFF262626FF00000000000000000000000000000000",
        "263498FF263498FF263498FF08090CFF262626FF1F265AFF23308FFF1F265AFF262626FF00000000000000000000000000000000000000000000000020262CFF191919FF0000000000000000262626FF131313FF00000000000000000000000000000000",
    ],
    [
        "522244FF522244FF522244FF522244FF522244FF522244FF3F1E31FF403326FF403326FF403326FF403326FF403326FF403326FF403326FF403326FF403326FF403326FF403326FF403326FF2C2F32FF0000000000000000000000000000000000000000",
        "BF1119FFBF1119FFBF1119FFBF1119FFBF1119FF7C0B10FF947256FFFFCC99FFFFBCB9FFFFB3CCFFFFB3CCFFFFB3CCFFFFB3CCFFFFB3CCFFFFB3CCFFFFB3CCFFFFB3CCFFFFB3CCFFFFC7A2FFD8AD82FF3A3C3EFF00000000000000000000000000000000",
        "F52A02FFF52A02FFF52A02FFF52A02FFF52A02FF490C00FFF0C090FFFFBCB9FFFF99FFFFFF99FFFFFF99FFFFFF99FFFFFF5FC5FFFF99FFFFFF66CCFFFF92F8FFFF94FAFFFF99FFFFFFA6E6FFFFCC99FF745D46FF00000000000000000000000000000000",
        "FC7800FFFC7800FFFC7800FFFC7800FFFC7800FF4C2400FFF0B6A2FFFF99FFFFFF66CCFFFF92F8FFFF99FFFFFF99FFFFFF99FFFFE88BE8FF634463FF342D34FFD580D5FFFF8DF3FFFF94FAFFFFA8E2FF745D46FF00000000202020FF0000000000000000",
        "FBA500FFFBA500FFFBA500FFFBA500FFFBA500FF4C3100FFF0B6A2FFFF99FFFFFF99FFFFFF99FFFFFF99FFFFFF99FFFFFF99FFFFA261A2FF5D5D5DFF929292FF5E4D5EFFC95BACFFFF92F8FFFFA6E6FF745D46FF342D34FF999999FF4A4A4AFF00000000",
        "F0D300FF988600FF3C3400FFEACE00FFF0D300FF483F00FFF0B6A2FFFF99FFFFFF99FFFFFF99FFFFFF99FFFFFF66CCFFFF92F8FFA261A2FF5D5D5DFF999999FF888888FF554755FF342D34FF342D34FF5C5650FF929292FF999999FF4A4A4AFF00000000",
        "889000FF4A4A4AFF999999FF212305FF889000FF292B00FFF0B6A2FFFF99FFFFFF99FFFFFF86ECFFFF99FFFFFF99FFFFF794F7FF885788FF6C6C6CFF999999FF999999FF999999FF999999FF999999FFA79999FFA1A1A1FF979797FF5D5D5DFF00000000",
        "438500FF394C25FF848484FF4A4A4AFF515151FF151515FFF0B6A2FFFF99FFFFFF99FFFFFF72D8FFFF99FFFFFF99FFFFE060B9FF383838FF999999FF9E9E9EFF9E9E9EFF7C7C7CFF999999FF999999FF999999FFBDBDBDFF656565FF999999FF2E2E2EFF",
        "2CCB13FF26B210FF24451FFF3F3F3FFF999999FF2E2E2EFFF0B6A2FFFF77DDFFFF80E6FFFF99FFFFFF99FFFFFF99FFFFE073CDFF383838FF999999FF929292FF2E2E2EFF5A5A5AFF979797FF767676FF656565FF4F4F4FFF2E2E2EFF979797FF202020FF",
        "20D15CFF20D15CFF20D15CFF1AAF4DFF083417FF020F06FFF0B6A2FFFF99FFFFFF99FFFFFF99FFFFFF92F8FFFF92F8FFE086E0FF383838FFD79999FFF69999FF8C8C8CFF888888FF979797FF7C7C7CFF999999FF7C7C7CFFB59999FFFF9999FF3E2525FF",
        "0EA7CBFF0EA7CBFF0EA7CBFF0EA7CBFF0EA7CBFF04323DFFF0BB99FFFFA8E2FFFF77DDFFFF92F8FFFF86ECFFFF86ECFFF090F0FF6D4C6DFF9A7B7BFFC79999FF656565FF2E2E2EFF4A4A4AFF151515FF4F4F4FFF151515FFA79999FFA57272FF00000000",
        "1E7FF7FF1E80F7FF1E7FF7FF1E7FF7FF1354A2FF000A14FFF0C090FFFFC7A2FFFF95D5FFFF99FFFFFF99FFFFFF99FFFFFF99FFFFE88BE8FF634463FF848484FF848484FF767676FF767676FF767676FF767676FF737373FF767676FF0000000000000000",
        "5247F7FF5247F7FF5247F7FF39329CFF5D5D5DFF4A4A4AFF251E17FFBF9973FFBF9973FFBF9973FFBF9973FFBF9973FFBF9973FFBF9973FFBF9973FF1D1711FF000000FF000000FF000000FF0C0C0CFF151515FF000A14FF000000000000000000000000",
        "5536D9FF5536D9FF5536D9FF202020FF999999FF6C6C6CFF241856FF202020FF4F4F4FFF070B0FFF00000000000000000000000000000000000A14FF414141FF342D34FF00000000000A14FF656565FF464646FF00000000000000000000000000000000",
        "263498FF263498FF263498FF070B0FFF202020FF1F265AFF1E297AFF111111FF202020FF000000000000000000000000000000000000000000000000202020FF000000000000000000000000202020FF151515FF00000000000000000000000000000000",
    ],
]

CAT_FRAMES = [_decode_frame(f) for f in _CAT_HEX]

RAINBOW_TRAIL = [
    [
        (82, 34, 68, 255),
        (191, 17, 25, 255),
        (245, 42, 2, 255),
        (252, 120, 0, 255),
        (251, 165, 0, 255),
        (196, 172, 0, 255),
        (136, 144, 0, 255),
        (67, 133, 0, 255),
        (44, 203, 19, 255),
        (32, 209, 92, 255),
        (14, 167, 203, 255),
        (30, 128, 247, 255),
        (82, 71, 247, 255),
        (85, 54, 217, 255),
        (38, 52, 152, 255),
    ],
    [
        (82, 34, 68, 255),
        (191, 17, 25, 255),
        (245, 42, 2, 255),
        (252, 120, 0, 255),
        (251, 165, 0, 255),
        (240, 211, 0, 255),
        (111, 117, 9, 255),
        (37, 37, 37, 255),
        (34, 124, 19, 255),
        (32, 209, 92, 255),
        (14, 167, 203, 255),
        (30, 128, 247, 255),
        (82, 71, 247, 255),
        (85, 54, 217, 255),
        (38, 52, 152, 255),
    ],
    [
        (82, 34, 68, 255),
        (191, 17, 25, 255),
        (245, 42, 2, 255),
        (252, 120, 0, 255),
        (251, 165, 0, 255),
        (240, 211, 0, 255),
        (180, 191, 0, 255),
        (77, 152, 1, 255),
        (44, 203, 19, 255),
        (24, 158, 69, 255),
        (12, 146, 178, 255),
        (30, 127, 247, 255),
        (82, 71, 247, 255),
        (85, 54, 217, 255),
        (38, 52, 152, 255),
    ],
    [
        (82, 34, 68, 255),
        (191, 17, 25, 255),
        (245, 42, 2, 255),
        (252, 120, 0, 255),
        (251, 165, 0, 255),
        (240, 211, 0, 255),
        (180, 191, 0, 255),
        (77, 152, 1, 255),
        (44, 203, 19, 255),
        (27, 127, 61, 255),
        (38, 38, 38, 255),
        (26, 81, 149, 255),
        (82, 71, 247, 255),
        (85, 54, 217, 255),
        (38, 52, 152, 255),
    ],
    [
        (82, 34, 68, 255),
        (191, 17, 25, 255),
        (245, 42, 2, 255),
        (252, 120, 0, 255),
        (251, 165, 0, 255),
        (240, 211, 0, 255),
        (111, 117, 9, 255),
        (19, 19, 19, 255),
        (32, 152, 14, 255),
        (32, 209, 92, 255),
        (14, 167, 203, 255),
        (30, 128, 247, 255),
        (82, 71, 247, 255),
        (85, 54, 217, 255),
        (38, 52, 152, 255),
    ],
    [
        (82, 34, 68, 255),
        (191, 17, 25, 255),
        (245, 42, 2, 255),
        (252, 120, 0, 255),
        (251, 165, 0, 255),
        (240, 211, 0, 255),
        (136, 144, 0, 255),
        (67, 133, 0, 255),
        (44, 203, 19, 255),
        (32, 209, 92, 255),
        (14, 167, 203, 255),
        (30, 127, 247, 255),
        (82, 71, 247, 255),
        (85, 54, 217, 255),
        (38, 52, 152, 255),
    ],
]


def make_png(width, height, pixels):
    def chunk(ctype, data):
        c = ctype + data
        crc = struct.pack(">I", zlib.crc32(c) & 0xFFFFFFFF)
        return struct.pack(">I", len(data)) + c + crc

    sig = b"\x89PNG\r\n\x1a\n"
    ihdr = chunk(b"IHDR", struct.pack(">IIBBBBB", width, height, 8, 6, 0, 0, 0))

    raw = b""
    for row in pixels:
        raw += b"\x00"
        for r, g, b, a in row:
            raw += struct.pack("BBBB", r, g, b, a)

    idat = chunk(b"IDAT", zlib.compress(raw))
    iend = chunk(b"IEND", b"")
    return sig + ihdr + idat + iend


def compose_scene(value, frame_idx):
    cat_x = int(value / 100.0 * (SCENE_W - CAT_W))
    cat_x = max(0, min(cat_x, SCENE_W - CAT_W))
    cat = CAT_FRAMES[frame_idx]
    trail = RAINBOW_TRAIL[frame_idx]

    CLEAR = (0, 0, 0, 0)
    scene = [[CLEAR] * SCENE_W for _ in range(SCENE_H)]

    for row in range(SCENE_H):
        color = trail[row]
        for x in range(cat_x):
            scene[row][x] = color

    for cy in range(CAT_H):
        for cx in range(CAT_W):
            px = cat[cy][cx]
            if px[3] > 0:
                sx = cat_x + cx
                if 0 <= sx < SCENE_W:
                    scene[cy][sx] = px

    return scene


def generate_scenes(value):
    os.makedirs(TMP_DIR, exist_ok=True)
    paths = []
    for i in range(NUM_FRAMES):
        scene = compose_scene(value, i)
        png_data = make_png(SCENE_W, SCENE_H, scene)
        path = os.path.join(TMP_DIR, f"scene_{i}.png")
        tmp_path = path + ".tmp"
        with open(tmp_path, "wb") as f:
            f.write(png_data)
        os.replace(tmp_path, path)
        paths.append(path)
    return paths


def anim_interval(value):
    t = max(0.0, min(value, 100.0)) / 100.0
    return SPEED_SLOW + t * (SPEED_FAST - SPEED_SLOW)


def get_cpu():
    try:
        r = subprocess.run(
            ["ps", "-A", "-o", "%cpu"], capture_output=True, text=True
        )
        lines = r.stdout.strip().split("\n")[1:]
        total = sum(float(x.strip()) for x in lines if x.strip())
        ncpu = os.cpu_count() or 1
        return min(total / ncpu, 100.0)
    except Exception:
        return 0.0


def get_battery():
    try:
        r = subprocess.run(
            ["pmset", "-g", "batt"], capture_output=True, text=True
        )
        for line in r.stdout.split("\n"):
            if "%" in line:
                for part in line.split():
                    if part.endswith("%;") or part.endswith("%"):
                        return float(part.rstrip("%;"))
        return 0.0
    except Exception:
        return 0.0


def ranma_add(name, **kwargs):
    args = ["ranma", "add", name]
    for key, value in kwargs.items():
        flag = "--" + key.replace("_", "-")
        args.extend([flag, str(value)])
    subprocess.run(args)


def ranma_set(name, **kwargs):
    args = ["ranma", "set", name]
    for key, value in kwargs.items():
        flag = "--" + key.replace("_", "-")
        args.extend([flag, str(value)])
    subprocess.run(args)


def setup(scene_paths):
    ranma_add(
        "nyan",
        type="row",
        align_items="center",
        background_color="#0a0a2e",
        corner_radius="8",
        shadow_color="#00000080",
        shadow_radius="8",
        margin_horizontal="4",
        margin_vertical="4",
        padding_horizontal="4",
        padding_vertical="4",
        notch_align="right",
    )
    ranma_add(
        "nyan.scene",
        parent="nyan",
        image=scene_paths[0],
        image_scale=str(IMAGE_SCALE),
    )


def make_source(name):
    if name == "cpu":
        return get_cpu, METRIC_POLL_CPU
    elif name == "battery":
        return get_battery, METRIC_POLL_BATTERY
    elif name == "stdin":
        state = {"value": 0.0}
        def reader():
            for line in sys.stdin:
                line = line.strip()
                if line:
                    try:
                        state["value"] = max(0.0, min(float(line), 100.0))
                    except ValueError:
                        pass
        t = threading.Thread(target=reader, daemon=True)
        t.start()
        return lambda: state["value"], 0.5
    elif name == "demo":
        start = time.monotonic()
        duration = 8.0
        def demo_reader():
            elapsed = time.monotonic() - start
            return min(elapsed / duration * 100.0, 100.0)
        return demo_reader, 0.1
    else:
        raise ValueError(f"Unknown source: {name}")


def cleanup():
    import shutil
    try:
        shutil.rmtree(TMP_DIR, ignore_errors=True)
    except Exception:
        pass


def run():
    parser = argparse.ArgumentParser()
    parser.add_argument("--source", default="cpu", choices=["cpu", "battery", "stdin", "demo"])
    args = parser.parse_args()

    read_metric, poll_interval = make_source(args.source)

    value = read_metric()
    scene_paths = generate_scenes(value)
    setup(scene_paths)

    frame_idx = 0
    last_poll = time.monotonic()
    prev_value = value

    try:
        while True:
            now = time.monotonic()
            if now - last_poll >= poll_interval:
                value = read_metric()
                if abs(value - prev_value) >= 0.5:
                    scene_paths = generate_scenes(value)
                    prev_value = value
                last_poll = now

            ranma_set("nyan.scene", image=scene_paths[frame_idx])
            frame_idx = (frame_idx + 1) % NUM_FRAMES
            time.sleep(anim_interval(value))
    except KeyboardInterrupt:
        pass
    finally:
        cleanup()


if __name__ == "__main__":
    run()
